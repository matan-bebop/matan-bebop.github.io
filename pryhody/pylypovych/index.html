<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF8">
  <title>Пригода Микити Пилиповича</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style> input, label, textarea {font-family: serif} </style>
</head>

<body>

<p></p>
<div id="prompt_line" style="display:flex; align-items: center">
  <div style="flex:none">Внутрішній голос:&nbsp</div>
  <input type="text" id="input"
	 onkeypress='if(event.key == "Enter") { enter() }'
	 autofocus onfocusout="refocus()"
	 style="width:100%; font-size: 1rem">
</div>

<script src="../swipl-bundle-devel.js"></script>

<script>

let resolve_input = undefined
var promise_read_input = new Promise(r => {resolve_input = r})

var swipl;
var swipl_options = {
  arguments: ["-q"],
  on_output: function(msg,stream) {
    console.log(msg)
    if (stream == "stdout") {
      const pars = document.getElementsByTagName("p")
      const last_par = pars[pars.length-1]
      if(last_par.textContent != "") {
        // SWIPL only flushes stdout on newline. So if we don't
        // have a fresh para, we also need to outpu a newline to
        // the current para.
        const br = document.createElement("br")
        last_par.appendChild(br)
      }
      last_par.append(msg)
    }
  }
};

async function new_game()
{
  swipl = await SWIPL(swipl_options)
  await swipl.prolog.consult("pylypovych-web.qlf")
  await swipl.prolog.load_scripts() /* переозначити ввід і вивід */
  await swipl.prolog.forEach("грати.").catch(error => block())
  // Чому я все одно отримую Unhandled promise rejection по ванільному halt?
}

new_game();

const output = document.getElementById("output");
prompt_line = document.getElementById("prompt_line")
input = document.getElementById("input")

function refocus() { setTimeout(function () { input.focus() }, 0) }

function enter() {
  /* It can be hard to input proper apostrophe symbol, and it seems that is
     merely impossible on iPhone. So, first, change every apostrophe-like
     symbol (except ") to proper apostrophe */
  /* TODO: properly treat quoted words and move this to Prolog, possibly by
     compiling it with PCRE. */
  input.value = input.value.replace(/[‘’’']/g, "ʼ")

  resolve_input(input.value)
  promise_read_input = new Promise(r => {resolve_input = r})
  paragraph("Внутрішній голос: " + capitalize(input.value))
  input.value = ""
  paragraph("")
}

function block() {
  input.style.display = "block"
}

function capitalize(s) { return s && s[0].toUpperCase() + s.slice(1) }
/* Ще треба б додавати в кінці крапочку, як нема. Але тоді парсер має
   розуміти команди з крапкою в кінці, щоби не плутати гравця */

/* Fucking iPhone scrolls about 5-6em before the element when the page is longer
   than one screen. Moreover, that amount depends on the input box font size. */
if(navigator.userAgent.includes("iPhone")) {
  prompt_line.style.paddingBottom = "15ex"
}

function paragraph(text) {
  const	new_par = document.createElement("p")
  new_par.innerText = text
  document.body.insertBefore(new_par, prompt_line)
  prompt_line.scrollIntoView(false)
}

</script>


<script type="text/prolog" id="aux.pl">

/* Завантажується після .qlf-модуля і переозначує потрібні предикати */

зчитати_рядок(Стр) :- Promise := promise_read_input, await(Promise, Стр).

пустий_рядок :-
	nl, % Заставити SWIPL вилити буфер виводу
	_ := paragraph("").

abort :- оповідь("Не підтримується у веб-версії.").

</script>


<!-- .qlf does not seem to load with load_scripts(), so I load it manually above
<script type="text/prolog" src="pilou-web.qlf"></script>
-->


</body>
</html>
